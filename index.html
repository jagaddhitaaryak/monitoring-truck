<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Status Truck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-container" class="min-h-screen flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-slate-600 font-semibold">Memuat Aplikasi...</p>
    </div>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4 hidden">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-slate-700 mb-2">Admin Login</h2>
            <div class="space-y-4">
                <div><label for="loginEmail" class="block text-sm font-medium text-slate-600 mb-1">Email</label><input type="email" id="loginEmail" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-slate-600 mb-1">Password</label><input type="password" id="loginPassword" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                <div id="loginError" class="text-red-500 text-sm"></div>
                <button id="loginButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Masuk</button>
            </div>
        </div>
    </div>
    
    <div id="dashboard-container" class="hidden">
        <div class="flex h-screen bg-slate-100">
            <aside class="w-64 flex-shrink-0 bg-slate-800 text-white flex flex-col">
                <div class="h-16 flex items-center justify-center px-4 border-b border-slate-700">
                    <h1 class="text-2xl font-bold tracking-wider"><i class="fas fa-truck-moving mr-2"></i>LOG IKK</h1>
                </div>
                <nav class="flex-grow px-4 py-4">
                    <a href="#" id="nav-home" class="sidebar-link flex items-center px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('home')">
                        <i class="fas fa-home w-6 text-center"></i><span class="ml-3">Home</span>
                    </a>
                    <a href="#" id="nav-statusTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('statusTruck')">
                        <i class="fas fa-eye w-6 text-center"></i><span class="ml-3">Status Truck</span>
                    </a>
                    <a href="#" id="nav-listTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('listTruck')">
                        <i class="fas fa-list-ul w-6 text-center"></i><span class="ml-3">List Truck</span>
                    </a>
                    <a href="#" id="nav-summaryReport" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('summaryReport')">
                        <i class="fas fa-chart-pie w-6 text-center"></i><span class="ml-3">Summary Report</span>
                    </a>
                </nav>
            </aside>

            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-md">
                    <div class="flex h-16 items-center justify-between px-8">
                        <div>
                            <h2 id="page-title" class="text-2xl font-bold text-slate-700">Home</h2>
                        </div>
                        <div class="flex items-center gap-4">
                            <div id="currentUserDisplay" class="text-sm font-medium text-slate-500"></div>
                            <button id="logoutButton" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600">Logout</button>
                        </div>
                    </div>
                </header>
                
                <main class="flex-grow p-4 md:p-6 lg:p-8 overflow-y-auto">
                    <div id="home" class="content-section">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                                <div class="p-4 bg-indigo-100 rounded-full"><i class="fas fa-truck text-3xl text-indigo-600"></i></div>
                                <div class="ml-4">
                                    <p class="text-slate-500 font-semibold">Total Truk</p>
                                    <p id="total-truck-count" class="text-3xl font-bold text-slate-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="statusTruck" class="content-section">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Status</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="statusCardFilterAngkutan" class="block text-sm font-medium text-slate-600 mb-1">Angkutan</label><select id="statusCardFilterAngkutan" onchange="window.displayStatusCards()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="statusCardFilterJenisMobil" class="block text-sm font-medium text-slate-600 mb-1">Jenis Truck</label><select id="statusCardFilterJenisMobil" onchange="window.displayStatusCards()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="statusCardFilterStatus" class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="statusCardFilterStatus" onchange="window.displayStatusCards()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                            </div>
                        </div>
                        <div id="readOnlyTruckList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>

                    <div id="listTruck" class="content-section">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <button class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.toggleAddForm()"><i class="fas fa-plus"></i> Tambah Data</button>
                            <div class="relative w-full md:w-1/3"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-400"></i></span><input type="text" id="searchInput" placeholder="Cari data truk..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                        </div>
                        <div class="add-form hidden bg-white p-6 rounded-xl shadow-md mb-6" id="addForm">
                            <h4 class="text-xl font-bold text-slate-700 mb-4">Tambah Truk Baru</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <input type="text" id="newAngkutan" placeholder="Angkutan" class="w-full p-2 border border-slate-300 rounded-lg"><input type="text" id="newNoMobil" placeholder="Plat Nomor" class="w-full p-2 border border-slate-300 rounded-lg">
                                <select id="newJenisMobil" class="w-full p-2 border border-slate-300 rounded-lg"><option value="LOSSBAK">LOSSBAK</option><option value="WINGBOX">WINGBOX</option></select>
                                <select id="newKeterangan" class="w-full p-2 border border-slate-300 rounded-lg"></select>
                                <input type="text" id="newFo" placeholder="Nomor FO" class="w-full p-2 border border-slate-300 rounded-lg"><input type="text" id="newNamaDriver" placeholder="Nama Driver" class="w-full p-2 border border-slate-300 rounded-lg">
                                <input type="text" id="newNoHp" placeholder="No HP Driver" class="w-full p-2 border border-slate-300 rounded-lg"><input type="text" id="newCustomer" placeholder="Nama Customer" class="w-full p-2 border border-slate-300 rounded-lg">
                                <input type="text" id="newTujuan" placeholder="Kota Tujuan" class="w-full p-2 border border-slate-300 rounded-lg"><input type="datetime-local" id="newWaktu" class="w-full p-2 border border-slate-300 rounded-lg" title="Waktu">
                                <div class="flex items-center gap-2 lg:col-start-4"><button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.addTruck()">Simpan</button><button class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg" onclick="window.toggleAddForm()">Batal</button></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto"><table id="truckTable" class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th class="px-6 py-3">Angkutan</th><th class="px-6 py-3">Plat Nomor</th><th class="px-6 py-3">Jenis Mobil</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Customer</th><th class="px-6 py-3">Tujuan</th><th class="px-6 py-3">Waktu</th><th class="px-6 py-3">Driver</th><th class="px-6 py-3">No HP</th><th class="px-6 py-3">FO</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <div id="summaryReport" class="content-section">
                         <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Laporan</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="summaryFilterAngkutan" class="block text-sm font-medium text-slate-600 mb-1">Angkutan</label><select id="summaryFilterAngkutan" onchange="window.renderSummaryReport()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="summaryFilterJenisMobil" class="block text-sm font-medium text-slate-600 mb-1">Jenis Mobil</label><select id="summaryFilterJenisMobil" onchange="window.renderSummaryReport()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="summaryFilterStatus" class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="summaryFilterStatus" onchange="window.renderSummaryReport()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto mb-6"><table id="summaryTable" class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th class="px-6 py-3">ANGKUTAN</th><th class="px-6 py-3">FO</th><th class="px-6 py-3">STATUS</th><th class="px-6 py-3">NAMA DRIVER</th><th class="px-6 py-3">NO HP</th><th class="px-6 py-3">PLAT NOMOR</th><th class="px-6 py-3">JENIS TRUCK</th></tr></thead><tbody id="summaryTableBody"></tbody></table></div>
                    </div>
                </main>
                <footer class="text-center p-4 text-sm text-slate-500 mt-auto bg-white border-t">&copy; <span id="copyright-year"></span> Jagaddhita Arya Koswara - Logistik IKK</footer>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.trucksData = []; 
        let jenisMobilOptions = [];
        let db, auth, currentUserData, unsubscribeFromTrucks;
        const appId = 'truck-dashboard-app';
        const statusOptions = ['TERSEDIA', 'OTW MUAT', 'ANTRI MUAT', 'MUAT', 'OTW CUSTOMER', 'ANTRI BONGKAR', 'INAP', 'STORING', 'NO DRIVER'];
        const statusInfo = { 'TERSEDIA': { icon: 'fa-check-circle', color: 'slate' }, 'OTW MUAT': { icon: 'fa-truck-loading', color: 'purple' }, 'ANTRI MUAT': { icon: 'fa-clock', color: 'cyan' }, 'MUAT': { icon: 'fa-box-open', color: 'blue' }, 'OTW CUSTOMER': { icon: 'fa-road', color: 'green' }, 'ANTRI BONGKAR': { icon: 'fa-hourglass-half', color: 'yellow' }, 'INAP': { icon: 'fa-bed', color: 'orange' }, 'STORING': { icon: 'fa-tools', color: 'red' }, 'NO DRIVER': { icon: 'fa-user-slash', color: 'rose' } };
        const statusBadgeMap = { 'TERSEDIA': 'bg-slate-100 text-slate-800', 'OTW MUAT': 'bg-purple-100 text-purple-800', 'ANTRI MUAT': 'bg-cyan-100 text-cyan-800', 'MUAT': 'bg-blue-100 text-blue-800', 'OTW CUSTOMER': 'bg-green-100 text-green-800', 'ANTRI BONGKAR': 'bg-yellow-100 text-yellow-800', 'INAP': 'bg-orange-100 text-orange-800', 'STORING': 'bg-red-100 text-red-800', 'NO DRIVER': 'bg-rose-100 text-rose-800' };
        const firebaseConfig = {
          apiKey: "AIzaSyBQYgVCVzHwBk-Am3MB425FdRXkV4U8bBw", authDomain: "truck-kontrak.firebaseapp.com", projectId: "truck-kontrak",
          storageBucket: "truck-kontrak.firebasestorage.app", messagingSenderId: "198359286959", appId: "1:198359286959:web:5d672f88d73ed05ab9805a", measurementId: "G-V2G0NSDVVB"
        };
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch(e) { console.error("Firebase Init Error:", e); }

        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeFromTrucks) unsubscribeFromTrucks();
            if (user) {
                try {
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                        currentUserData = userDocSnap.data();
                        document.getElementById('currentUserDisplay').textContent = `Selamat datang, ${currentUserData.name || 'Admin'} (Admin)`;
                        setupRealtimeListener(); 
                        document.getElementById('loading-container').classList.add('hidden');
                        document.getElementById('login-container').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        window.showContent('home'); 
                    } else { await signOut(auth); }
                } catch (error) { await signOut(auth); }
            } else {
                document.getElementById('loading-container').classList.add('hidden');
                document.getElementById('dashboard-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
            }
        });
        
        function setupRealtimeListener() {
             if (!currentUserData) return;
             const trucksCollectionRef = collection(db, `artifacts/${appId}/public/data/trucks`);
             unsubscribeFromTrucks = onSnapshot(trucksCollectionRef, (snapshot) => {
                 let needsFullRender = window.trucksData.length !== snapshot.size;
                 snapshot.docChanges().forEach((change) => {
                     const truckData = { ...change.doc.data(), firestoreId: change.doc.id };
                     const index = window.trucksData.findIndex(t => t.firestoreId === change.doc.id);
                     if (change.type === "added") { if (index === -1) window.trucksData.push(truckData); needsFullRender = true; }
                     if (change.type === "modified") {
                         if (index > -1) { window.trucksData[index] = truckData; updateTableRow(truckData); updateStatusCard(truckData); } 
                         else { needsFullRender = true; }
                     }
                     if (change.type === "removed") { if (index > -1) window.trucksData.splice(index, 1); needsFullRender = true; }
                 });
                 if (needsFullRender) { renderTruckList(window.trucksData); displayStatusCards(); }
                 jenisMobilOptions = [...new Set(window.trucksData.map(t => t.jenis_mobil))].sort();
                 updateDashboardCards(); populateAddFormOptions(); populateSummaryFilters(); populateStatusCardFilters();
                 if (document.getElementById('summaryReport').classList.contains('active')) renderSummaryReport();
             }, (error) => console.error("Data Listener Error:", error));
        }
        
        window.updateDashboardCards = function() {
            if (!window.trucksData) return;
            document.getElementById('total-truck-count').textContent = window.trucksData.length;
            const container = document.querySelector('#home .grid');
            while (container.children.length > 1) { container.removeChild(container.lastChild); }
            statusOptions.forEach(status => {
                const count = window.trucksData.filter(truck => truck.keterangan === status).length;
                const info = statusInfo[status] || { icon: 'fa-question-circle', color: 'gray' };
                if (!document.getElementById(`status-card-${status}`)) {
                    const card = document.createElement('div'); card.id = `status-card-${status}`;
                    card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center';
                    card.innerHTML = `<div class="p-4 bg-${info.color}-100 rounded-full"><i class="fas ${info.icon} text-3xl text-${info.color}-600"></i></div><div class="ml-4"><p class="text-slate-500 font-semibold">${status}</p><p id="count-${status}" class="text-3xl font-bold text-slate-800">${count}</p></div>`;
                    container.appendChild(card);
                } else { document.getElementById(`count-${status}`).textContent = count; }
            });
        }
        
        function renderTruckList(dataToRender) {
            const tableBody = document.getElementById('truckTable').querySelector('tbody');
            tableBody.innerHTML = '';
            if (!dataToRender || dataToRender.length === 0) { tableBody.innerHTML = `<tr><td colspan="12" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`; return; }
            const sortedData = [...dataToRender].sort((a, b) => (a.angkutan || '').localeCompare(b.angkutan || ''));
            sortedData.forEach((truck) => tableBody.appendChild(createTableRow(truck)));
            filterTable();
        }

        function createTableRow(truck) {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-slate-50';
            row.setAttribute('data-id', truck.firestoreId);
            updateTableRow(truck, row);
            return row;
        }

        function updateTableRow(truck, rowElement) {
            const row = rowElement || document.querySelector(`#truckTable tr[data-id="${truck.firestoreId}"]`);
            if (!row) return;
            const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
            const [tanggal, jam] = (truck.waktu || 'T').split('T');
            const waktuDisplay = tanggal && jam ? `${tanggal}, ${jam}` : '-';

            row.innerHTML = `
                <td data-field="angkutan" class="px-6 py-4 font-medium">${truck.angkutan || '-'}</td><td data-field="no_mobil" class="px-6 py-4">${truck.no_mobil || '-'}</td>
                <td data-field="jenis_mobil" class="px-6 py-4">${truck.jenis_mobil || '-'}</td><td data-field="keterangan" class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${truck.keterangan || '-'}</span></td>
                <td data-field="customer" class="px-6 py-4">${truck.customer || '-'}</td><td data-field="tujuan" class="px-6 py-4">${truck.tujuan || '-'}</td>
                <td data-field="waktu" class="px-6 py-4">${waktuDisplay}</td><td data-field="nama_driver" class="px-6 py-4">${truck.nama_driver || '-'}</td>
                <td data-field="no_hp" class="px-6 py-4">${truck.no_hp || '-'}</td><td data-field="fo" class="px-6 py-4">${truck.fo || '-'}</td>
                <td class="px-6 py-4 action-buttons flex items-center gap-2"><button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" onclick="window.editRow('${truck.firestoreId}')"><i class="fas fa-pencil-alt"></i></button><button class="delete p-2 text-xs text-white bg-red-600 rounded-lg hover:bg-red-700" onclick="window.deleteTruck('${truck.firestoreId}', '${truck.no_mobil}')"><i class="fas fa-trash"></i></button></td>`;
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tableBody = document.getElementById('truckTable').querySelector('tbody');
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => { row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none'; });
        }
        
        window.addTruck = async function() {
            const newTruck = {
                angkutan: document.getElementById('newAngkutan').value.trim(), no_mobil: document.getElementById('newNoMobil').value.trim(),
                jenis_mobil: document.getElementById('newJenisMobil').value, keterangan: document.getElementById('newKeterangan').value,
                fo: document.getElementById('newFo').value.trim(), nama_driver: document.getElementById('newNamaDriver').value.trim(),
                no_hp: document.getElementById('newNoHp').value.trim(), customer: document.getElementById('newCustomer').value.trim(),
                tujuan: document.getElementById('newTujuan').value.trim(), waktu: document.getElementById('newWaktu').value
            };
            if (!newTruck.angkutan || !newTruck.no_mobil || !newTruck.jenis_mobil) { alert("Kolom Angkutan, Plat Nomor, dan Jenis Mobil wajib diisi."); return; }
            try { await addDoc(collection(db, `artifacts/${appId}/public/data/trucks`), newTruck); window.toggleAddForm(true); } 
            catch (error) { alert("Gagal menyimpan data baru."); }
        };

        window.editRow = (firestoreId) => {
            cancelEdit();
            const row = document.querySelector(`tr[data-id="${firestoreId}"]`); if (!row) return;
            const truck = window.trucksData.find(t => t.firestoreId === firestoreId); if (!truck) return;
            const createInput = (value, type = 'text') => `<input type="${type}" class="w-full p-2 border border-slate-300 rounded-lg" value="${value}">`;
            const createSelect = (options, selectedValue) => `<select class="w-full p-2 border border-slate-300 rounded-lg">${options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.dataset.field; const value = truck[field] || '';
                if(field === 'waktu') cell.innerHTML = createInput(truck.waktu || '', 'datetime-local');
                else if(field === 'jenis_mobil') cell.innerHTML = createSelect(['LOSSBAK', 'WINGBOX'], value);
                else if(field === 'keterangan') cell.innerHTML = createSelect(statusOptions, value);
                else cell.innerHTML = createInput(value);
            });
            row.querySelector('.action-buttons').innerHTML = `<button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveRow('${firestoreId}')"><i class="fas fa-check"></i></button><button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg" onclick="window.cancelEdit()"><i class="fas fa-times"></i></button>`;
        };

        window.saveRow = async (firestoreId) => {
            const row = document.querySelector(`tr[data-id="${firestoreId}"]`); if (!row) return;
            const updatedData = {};
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.dataset.field;
                const input = cell.querySelector('input, select');
                if (input) updatedData[field] = input.value;
            });
            try { await updateDoc(doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId), updatedData); } 
            catch (error) { alert("Gagal menyimpan perubahan."); }
        };

        window.deleteTruck = async (firestoreId, noMobil) => {
            if (confirm(`Yakin ingin menghapus truk ${noMobil}?`)) {
                try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId)); }
                catch (error) { alert("Gagal menghapus data."); }
            }
        };
        
        window.cancelEdit = () => renderTruckList(window.trucksData);

        window.toggleAddForm = (forceClose = false) => {
            const form = document.getElementById('addForm');
            const isHidden = form.classList.contains('hidden');
            if (forceClose || !isHidden) {
                form.classList.add('hidden');
            } else {
                document.getElementById('newAngkutan').value = ''; document.getElementById('newNoMobil').value = '';
                document.getElementById('newJenisMobil').value = "LOSSBAK"; document.getElementById('newKeterangan').value = statusOptions[0];
                document.getElementById('newFo').value = ''; document.getElementById('newNamaDriver').value = ''; document.getElementById('newNoHp').value = '';
                document.getElementById('newCustomer').value = ''; document.getElementById('newTujuan').value = ''; document.getElementById('newWaktu').value = '';
                form.classList.remove('hidden');
            }
        };
        
        function populateAddFormOptions() {
             document.getElementById('newKeterangan').innerHTML = statusOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }
        
        function populateStatusCardFilters() {
            const angkutanSelect = document.getElementById('statusCardFilterAngkutan'), jenisMobilSelect = document.getElementById('statusCardFilterJenisMobil'), statusSelect = document.getElementById('statusCardFilterStatus');
            const uniqueAngkutan = [...new Set(window.trucksData.map(t => t.angkutan))].sort();
            angkutanSelect.innerHTML = '<option value="all">Semua Angkutan</option>'; uniqueAngkutan.forEach(a => angkutanSelect.innerHTML += `<option value="${a}">${a}</option>`);
            jenisMobilSelect.innerHTML = '<option value="all">Semua Jenis</option>'; jenisMobilOptions.forEach(j => jenisMobilSelect.innerHTML += `<option value="${j}">${j}</option>`);
            statusSelect.innerHTML = '<option value="all">Semua Status</option>'; statusOptions.forEach(s => statusSelect.innerHTML += `<option value="${s}">${s}</option>`);
        }
        
        window.displayStatusCards = () => {
            const container = document.getElementById('readOnlyTruckList'); 
            const selectedAngkutan = document.getElementById('statusCardFilterAngkutan').value, selectedJenisMobil = document.getElementById('statusCardFilterJenisMobil').value, selectedStatus = document.getElementById('statusCardFilterStatus').value;
            let filteredTrucks = window.trucksData;
            if (selectedAngkutan !== 'all') filteredTrucks = filteredTrucks.filter(t => t.angkutan === selectedAngkutan);
            if (selectedJenisMobil !== 'all') filteredTrucks = filteredTrucks.filter(t => t.jenis_mobil === selectedJenisMobil);
            if (selectedStatus !== 'all') filteredTrucks = filteredTrucks.filter(t => t.keterangan === selectedStatus);
            container.innerHTML = '';
            if (!filteredTrucks || filteredTrucks.length === 0) { container.innerHTML = `<p class="text-slate-500 col-span-full text-center">Tidak ada data.</p>`; return; }
            const sortedTrucks = [...filteredTrucks].sort((a, b) => statusOptions.indexOf(a.keterangan) - statusOptions.indexOf(b.keterangan));
            sortedTrucks.forEach((truck) => container.appendChild(createStatusCard(truck)));
        }

        function createStatusCard(truck) {
            const card = document.createElement('div'); card.className = 'bg-white p-6 rounded-xl shadow-md';
            card.setAttribute('data-id', truck.firestoreId);
            updateStatusCard(truck, card);
            return card;
        }

        function updateStatusCard(truck, cardElement) {
            const card = cardElement || document.querySelector(`#readOnlyTruckList div[data-id="${truck.firestoreId}"]`);
            if (!card) return;
            const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
            const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
            const kubikasi = (p * l * t / 1000000).toFixed(2);
            const [tanggal, jam] = (truck.waktu || 'T').split('T');
            const waktuDisplay = tanggal && jam ? `${tanggal}, ${jam}` : '-';
            card.innerHTML = `<div class="flex justify-between items-start"><h3 class="text-lg font-bold text-slate-800">${truck.no_mobil}</h3><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${truck.keterangan || 'N/A'}</span></div><p class="text-sm text-slate-500 mb-4">${truck.jenis_mobil || ''}</p><div class="border-t border-slate-200 pt-4 mt-4 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Customer:</span><span class="text-slate-700 font-semibold">${truck.customer || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kota:</span><span class="text-slate-700 font-semibold">${truck.tujuan || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Waktu:</span><span class="text-slate-700 font-semibold">${waktuDisplay}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Driver:</span><span class="text-slate-700 font-semibold">${truck.nama_driver || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No HP:</span><span class="text-slate-700 font-semibold">${truck.no_hp || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No. FO:</span><span class="text-slate-700 font-semibold">${truck.fo || '-'}</span></div></div><div class="border-t border-slate-200 pt-2 mt-2 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Dimensi:</span><span class="text-slate-700 font-semibold">${p}×${l}×${t} cm</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kubikasi:</span><span class="text-slate-700 font-bold text-indigo-600">${kubikasi} m³</span></div></div>`;
        }
        
        function populateSummaryFilters() {
            const angkutanSelect = document.getElementById('summaryFilterAngkutan'), jenisMobilSelect = document.getElementById('summaryFilterJenisMobil'), statusSelect = document.getElementById('summaryFilterStatus');
            const uniqueAngkutan = [...new Set(window.trucksData.map(t => t.angkutan))].sort();
            angkutanSelect.innerHTML = '<option value="all">Semua Angkutan</option>'; uniqueAngkutan.forEach(a => angkutanSelect.innerHTML += `<option value="${a}">${a}</option>`);
            jenisMobilSelect.innerHTML = '<option value="all">Semua Jenis</option>'; jenisMobilOptions.forEach(j => jenisMobilSelect.innerHTML += `<option value="${j}">${j}</option>`);
            statusSelect.innerHTML = '<option value="all">Semua Status</option>'; statusOptions.forEach(s => statusSelect.innerHTML += `<option value="${s}">${s}</option>`);
        }

        window.renderSummaryReport = function() {
            let filteredData = window.trucksData;
            const selectedAngkutan = document.getElementById('summaryFilterAngkutan').value, selectedJenisMobil = document.getElementById('summaryFilterJenisMobil').value, selectedStatus = document.getElementById('summaryFilterStatus').value;
            if (selectedAngkutan !== 'all') filteredData = filteredData.filter(t => t.angkutan === selectedAngkutan);
            if (selectedJenisMobil !== 'all') filteredData = filteredData.filter(t => t.jenis_mobil === selectedJenisMobil);
            if (selectedStatus !== 'all') filteredData = filteredData.filter(t => t.keterangan === selectedStatus);
            const tableBody = document.getElementById('summaryTableBody'); tableBody.innerHTML = '';
            if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`; return; }
            filteredData.forEach(truck => {
                const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
                tableBody.innerHTML += `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium">${truck.angkutan || '-'}</td><td class="px-6 py-4">${truck.fo || '-'}</td><td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${truck.keterangan || '-'}</span></td><td class="px-6 py-4">${truck.nama_driver || '-'}</td><td class="px-6 py-4">${truck.no_hp || '-'}</td><td class="px-6 py-4">${truck.no_mobil || '-'}</td><td class="px-6 py-4">${truck.jenis_mobil || '-'}</td></tr>`;
            });
        }

        const pageTitles = { home: 'Home', statusTruck: 'Status Truck', listTruck: 'List Truck', summaryReport: 'Summary Report' };
        window.showContent = (contentId) => {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(contentId).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${contentId}`).classList.add('active');
            document.getElementById('page-title').textContent = pageTitles[contentId];
            if (contentId === 'summaryReport') renderSummaryReport();
            if (contentId === 'statusTruck') displayStatusCards();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginButton').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value).catch(() => document.getElementById('loginError').textContent = 'Email/password salah.'));
            document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
            document.getElementById('searchInput').addEventListener('keyup', filterTable);
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>