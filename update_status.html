<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Status Truk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }

        /* Styling untuk Pop-up Filter Header */
        .header-filter-popup {
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 1010;
            width: 250px;
            padding: 0.5rem;
        }
        .filter-options {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .filter-item { display: block; margin-bottom: 0.5rem; }
        th[data-filter] { cursor: pointer; position: relative; }
        th[data-filter]:hover { background-color: #eef2ff; }
        th[data-filter]::after {
            content: '\f0d7'; /* Font Awesome down arrow */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 8px;
            color: #94a3b8;
        }

        /* Styling untuk Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 900px; max-height: 90vh;
            display: flex; flex-direction: column; position: relative;
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1.5rem;
            font-size: 2rem; font-weight: bold; color: #64748b; cursor: pointer;
        }
        .modal-body { overflow-y: auto; }
        th[data-sort] { cursor: pointer; }
        th[data-sort]:hover { background-color: #eef2ff; }

    </style>
</head>
<body class="text-slate-800">

    <div id="loading-container" class="min-h-screen flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-slate-600 font-semibold">Memuat...</p>
    </div>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4 hidden">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-slate-700 mb-2">Login Angkutan</h2>
            <p class="text-center text-slate-500 mb-6">Silakan masuk</p>
            <div class="space-y-4">
                <div><label for="loginEmail" class="block text-sm font-medium text-slate-600 mb-1">Email</label><input type="email" id="loginEmail" placeholder="akun.angkutan@email.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-slate-600 mb-1">Password</label><input type="password" id="loginPassword" placeholder="••••••••" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                <div id="loginError" class="text-red-500 text-sm"></div>
                <button id="loginButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-indigo-700">Masuk</button>
            </div>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <div class="flex h-screen bg-slate-100">
            <aside class="w-64 flex-shrink-0 bg-slate-800 text-white flex flex-col">
                <div class="h-16 flex items-center justify-center px-4 border-b border-slate-700">
                     <h1 class="text-2xl font-bold tracking-wider"><i class="fas fa-truck-moving mr-2"></i>LOG IKK</h1>
                </div>
                <nav class="flex-grow px-4 py-4">
                    <a href="#" id="nav-home" class="sidebar-link flex items-center px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('home')">
                        <i class="fas fa-home w-6 text-center"></i><span class="ml-3">Home</span>
                    </a>
                    <a href="#" id="nav-statusTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('statusTruck')">
                        <i class="fas fa-eye w-6 text-center"></i><span class="ml-3">Status Truck</span>
                    </a>
                    <a href="#" id="nav-updateStatus" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('updateStatus')">
                        <i class="fas fa-edit w-6 text-center"></i><span class="ml-3">Update Status Truck</span>
                    </a>
                    <a href="#" id="nav-updateDimensi" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('updateDimensi')">
                        <i class="fas fa-ruler-combined w-6 text-center"></i><span class="ml-3">Update Dimensi</span>
                    </a>
                    <a href="#" id="nav-ritaseTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('ritaseTruck')">
                        <i class="fas fa-route w-6 text-center"></i><span class="ml-3">Ritase Truck</span>
                    </a>
                    <a href="#" id="nav-summaryReport" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('summaryReport')">
                        <i class="fas fa-chart-pie w-6 text-center"></i><span class="ml-3">Summary Report</span>
                    </a>
                </nav>
            </aside>

            <div class="flex-1 flex flex-col overflow-hidden">
                 <header class="bg-white shadow-md">
                    <div class="flex h-16 items-center justify-between px-8">
                        <div><h2 id="page-title" class="text-2xl font-bold text-slate-700">Home</h2></div>
                        <div class="flex items-center gap-4">
                             <div id="angkutanNameDisplay" class="text-sm font-medium text-indigo-600"></div>
                             <button id="logoutButton" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-slate-300">Logout</button>
                        </div>
                    </div>
                </header>

                <main class="flex-grow p-4 md:p-6 lg:p-8 overflow-y-auto">
                    <div id="home" class="content-section">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                                <div class="p-4 bg-indigo-100 rounded-full"><i class="fas fa-truck text-3xl text-indigo-600"></i></div>
                                <div class="ml-4">
                                    <p class="text-slate-500 font-semibold">Total Truk Anda</p>
                                    <p id="total-truck-count" class="text-3xl font-bold text-slate-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="statusTruck" class="content-section"><div id="readOnlyTruckList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                    <div id="updateStatus" class="content-section"><div id="truckListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                    <div id="updateDimensi" class="content-section">
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-slate-100"><tr><th class="px-6 py-3">Plat Nomor</th><th class="px-6 py-3">Jenis Truck</th><th class="px-6 py-3">Panjang (cm)</th><th class="px-6 py-3">Lebar (cm)</th><th class="px-6 py-3">Tinggi (cm)</th><th class="px-6 py-3">Kubikasi (m³)</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="dimensiTableBody"></tbody></table>
                        </div>
                    </div>

                    <div id="ritaseTruck" class="content-section">
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3" data-filter="plat_nomor" onclick="handleHeaderClick(event, 'plat_nomor')">Plat Nomor</th>
                                        <th class="px-6 py-3" data-filter="nama_driver" onclick="handleHeaderClick(event, 'nama_driver')">Nama Driver</th>
                                        <th class="px-6 py-3" data-filter="customer" onclick="handleHeaderClick(event, 'customer')">Customer</th>
                                        <th class="px-6 py-3" data-filter="tujuan" onclick="handleHeaderClick(event, 'tujuan')">Kota</th>
                                        <th class="px-6 py-3" data-filter="timestamp_selesai" onclick="handleHeaderClick(event, 'timestamp_selesai')">Tanggal Selesai</th>
                                        <th class="px-6 py-3" data-filter="fo" onclick="handleHeaderClick(event, 'fo')">FO</th>
                                    </tr>
                                </thead>
                                <tbody id="ritaseTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="summaryReport" class="content-section">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <div>
                                <h4 class="text-xl font-bold text-slate-800">Summary Report</h4>
                                <p id="export-timestamp" class="text-sm text-slate-500">Data saat ini</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="window.exportToExcel()" class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button onclick="window.exportToPdf()" class="flex items-center gap-2 bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="summaryTable" class="w-full text-sm text-left"><thead class="text-xs uppercase bg-slate-100"><tr><th class="px-6 py-3">FO</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Nama Driver</th><th class="px-6 py-3">No HP</th><th class="px-6 py-3">Plat Nomor</th><th class="px-6 py-3">Jenis Mobil</th></tr></thead><tbody id="summaryTableBody"></tbody></table>
                        </div>
                    </div>
                </main>
                <footer class="text-center p-4 text-sm text-slate-500 mt-auto bg-white border-t">&copy; <span id="copyright-year"></span> Jagaddhita Arya Koswara - Logistik IKK</footer>
            </div>
        </div>
    </div>

    <div id="status-modal" class="modal-overlay hidden" onclick="window.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="window.closeModal()">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk</h3>
            <div class="flex items-center gap-4 mb-4">
                <input type="text" id="modalSearchInput" placeholder="Cari..." class="w-full p-2 border border-slate-300 rounded-lg" oninput="window.applyModalFiltersAndSort()">
            </div>
            <div class="modal-body">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortModalTable('no_mobil')">Plat Nomor</th>
                            <th class="px-4 py-3" data-sort="nama_driver" onclick="window.sortModalTable('nama_driver')">Nama Driver</th>
                            <th class="px-4 py-3" data-sort="no_hp" onclick="window.sortModalTable('no_hp')">No HP</th>
                            <th class="px-4 py-3" data-sort="jenis_mobil" onclick="window.sortModalTable('jenis_mobil')">Jenis Truck</th>
                            <th class="px-4 py-3">Dimensi (cm)</th>
                            <th class="px-4 py-3">Kubikasi (m³)</th>
                        </tr>
                    </thead>
                    <tbody id="modal-truck-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="header-filter-popup" class="header-filter-popup hidden">
        <input type="text" id="filter-search" class="w-full p-2 border border-slate-300 rounded-md mb-2" placeholder="Cari opsi...">
        <div id="filter-options" class="filter-options"></div>
        <div class="flex justify-end gap-2 pt-2 border-t">
            <button id="apply-filter-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm font-semibold">Terapkan</button>
            <button id="clear-filter-btn" class="bg-slate-200 px-3 py-1 rounded-md text-sm">Hapus Filter</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, query, where, getDoc, addDoc, serverTimestamp, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, currentUserData, unsubscribeFromTrucks;
        let trucksData = [];
        let allRitaseData = []; 
        let ritaseSort = { column: 'timestamp_selesai', direction: 'desc' };
        let activeFilters = {};
        // ===== START: MODAL SCRIPT VARIABLES =====
        let currentModalTrucks = [];
        let modalSort = { column: 'no_mobil', direction: 'asc' };
        // ===== END: MODAL SCRIPT VARIABLES =====
        const appId = 'truck-dashboard-app';
        const statusOptions = ['TERSEDIA', 'OTW MUAT', 'ANTRI MUAT', 'MUAT', 'OTW CUSTOMER', 'ANTRI BONGKAR', 'INAP', 'STORING', 'NO DRIVER'];
        const statusInfo = { 'TERSEDIA': { icon: 'fa-check-circle', color: 'slate' }, 'OTW MUAT': { icon: 'fa-truck-loading', color: 'purple' }, 'ANTRI MUAT': { icon: 'fa-clock', color: 'cyan' }, 'MUAT': { icon: 'fa-box-open', color: 'blue' }, 'OTW CUSTOMER': { icon: 'fa-road', color: 'green' }, 'ANTRI BONGKAR': { icon: 'fa-hourglass-half', color: 'yellow' }, 'INAP': { icon: 'fa-bed', color: 'orange' }, 'STORING': { icon: 'fa-tools', color: 'red' }, 'NO DRIVER': { icon: 'fa-user-slash', color: 'rose' } };
        const statusBadgeMap = { 'TERSEDIA': 'bg-slate-100 text-slate-800', 'OTW MUAT': 'bg-purple-100 text-purple-800', 'ANTRI MUAT': 'bg-cyan-100 text-cyan-800', 'MUAT': 'bg-blue-100 text-blue-800', 'OTW CUSTOMER': 'bg-green-100 text-green-800', 'ANTRI BONGKAR': 'bg-yellow-100 text-yellow-800', 'INAP': 'bg-orange-100 text-orange-800', 'STORING': 'bg-red-100 text-red-800', 'NO DRIVER': 'bg-rose-100 text-rose-800' };

        const firebaseConfig = {
          apiKey: "AIzaSyBQYgVCVzHwBk-Am3MB425FdRXkV4U8bBw", authDomain: "truck-kontrak.firebaseapp.com", projectId: "truck-kontrak",
          storageBucket: "truck-kontrak.firebasestorage.app", messagingSenderId: "198359286959", appId: "1:198359286959:web:5d672f88d73ed05ab9805a", measurementId: "G-V2G0NSDVVB"
        };
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch(e) { console.error("Firebase Init Error:", e); }

        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeFromTrucks) unsubscribeFromTrucks();
            if (user) {
                try {
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    if (userDocSnap.exists() && userDocSnap.data().role === 'angkutan') {
                        currentUserData = userDocSnap.data();
                        document.getElementById('angkutanNameDisplay').textContent = currentUserData.angkutanName;
                        setupRealtimeListener(currentUserData.angkutanName);
                        document.getElementById('loading-container').classList.add('hidden');
                        document.getElementById('login-container').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        window.showContent('home');
                    } else { await signOut(auth); }
                } catch (error) { await signOut(auth); }
            } else {
                document.getElementById('loading-container').classList.add('hidden');
                document.getElementById('dashboard-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
            }
        });

        function setupRealtimeListener(angkutanName) {
            const trucksCollectionRef = collection(db, `artifacts/${appId}/public/data/trucks`);
            const q = query(trucksCollectionRef, where("angkutan", "==", angkutanName));
            unsubscribeFromTrucks = onSnapshot(q, (snapshot) => {
                let needsFullPageRender = trucksData.length !== snapshot.size;
        
                snapshot.docChanges().forEach((change) => {
                    const truckData = { ...change.doc.data(), firestoreId: change.doc.id };
                    const index = trucksData.findIndex(t => t.firestoreId === change.doc.id);
        
                    if (change.type === "added") {
                        if (index === -1) trucksData.push(truckData);
                        needsFullPageRender = true;
                    }
                    if (change.type === "modified") {
                        if (index > -1) {
                            trucksData[index] = truckData;
                            const oldEditableCard = document.querySelector(`#truckListContainer div[data-id="${change.doc.id}"]`);
                            if (oldEditableCard) oldEditableCard.replaceWith(createTruckCard(truckData));
                            const oldStatusCard = document.querySelector(`#readOnlyTruckList div[data-id="${change.doc.id}"]`);
                            if (oldStatusCard) oldStatusCard.replaceWith(createStatusCard(truckData));
                        } else {
                            needsFullPageRender = true;
                        }
                    }
                    if (change.type === "removed") {
                        if (index > -1) trucksData.splice(index, 1);
                        needsFullPageRender = true;
                    }
                });
        
                updateDashboardCards(trucksData);
                renderSummaryReport(trucksData);
        
                if (needsFullPageRender) {
                    displayStatusCards(trucksData);
                    displayDimensiTable(trucksData);
                    if (document.getElementById('updateStatus').classList.contains('active')) {
                         const container = document.getElementById('truckListContainer');
                         container.innerHTML = '';
                         trucksData.forEach(truck => container.appendChild(createTruckCard(truck)));
                    }
                }
            }, (error) => console.error("Gagal mengambil data truk: ", error));
        }
        
        function updateDashboardCards(data) {
             if (!data) return;
             document.getElementById('total-truck-count').textContent = data.length;
             const container = document.querySelector('#home .grid');
             document.querySelectorAll('.status-card[data-status]').forEach(card => card.remove());
             statusOptions.forEach(status => {
                const count = data.filter(truck => truck.keterangan === status).length;
                const info = statusInfo[status] || { icon: 'fa-question-circle', color: 'gray' };
                const card = document.createElement('div');
                card.dataset.status = status;
                card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center status-card';
                card.style.cursor = 'pointer';
                card.innerHTML = `<div class="p-4 bg-${info.color}-100 rounded-full"><i class="fas ${info.icon} text-3xl text-${info.color}-600"></i></div><div class="ml-4"><p class="text-slate-500 font-semibold">${status}</p><p class="text-3xl font-bold text-slate-800">${count}</p></div>`;
                card.onclick = () => window.showTrucksByStatus(status);
                container.appendChild(card);
            });
        }

        function createTruckCard(truck) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-md transition hover:shadow-lg flex flex-col justify-between';
            card.setAttribute('data-id', truck.firestoreId);
            let optionsHtml = statusOptions.map(opt => `<option value="${opt}" ${truck.keterangan === opt ? 'selected' : ''}>${opt}</option>`).join('');
            const finishButtonHtml = `<button class="w-full bg-green-600 text-white font-semibold px-4 py-2 rounded-lg mt-2 shadow-sm hover:bg-green-700" onclick="window.finishDelivery('${truck.firestoreId}')">Delivery Selesai</button>`;
            card.innerHTML = `<div><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800">${truck.no_mobil}</h3><span class="text-xs font-semibold bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${truck.jenis_mobil}</span></div><div class="space-y-3"><div><label class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="status-select-${truck.firestoreId}" class="w-full p-2 border border-slate-300 rounded-lg">${optionsHtml}</select></div><div><label class="block text-sm font-medium text-slate-600 mb-1">Customer</label><input type="text" id="customer-input-${truck.firestoreId}" value="${truck.customer || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block text-sm font-medium text-slate-600 mb-1">Kota</label><input type="text" id="tujuan-input-${truck.firestoreId}" value="${truck.tujuan || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block text-sm font-medium text-slate-600 mb-1">Waktu</label><input type="datetime-local" id="waktu-input-${truck.firestoreId}" value="${truck.waktu || ''}" class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block text-sm font-medium text-slate-600 mb-1">Nama Driver</label><input type="text" id="driver-input-${truck.firestoreId}" value="${truck.nama_driver || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block text-sm font-medium text-slate-600 mb-1">No HP</label><input type="text" id="hp-input-${truck.firestoreId}" value="${truck.no_hp || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block text-sm font-medium text-slate-600 mb-1">FO</label><input type="text" id="fo-input-${truck.firestoreId}" value="${truck.fo || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg"></div></div></div><div class="mt-4"><button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700" onclick="window.updateTruckStatus('${truck.firestoreId}', this)">Update Semua Info</button>${finishButtonHtml}</div>`;
            return card;
        }

        window.updateTruckStatus = async (firestoreId, buttonElement) => {
            buttonElement.disabled = true; buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            const dataToUpdate = {
                keterangan: document.getElementById(`status-select-${firestoreId}`).value,
                nama_driver: document.getElementById(`driver-input-${firestoreId}`).value,
                no_hp: document.getElementById(`hp-input-${firestoreId}`).value,
                fo: document.getElementById(`fo-input-${firestoreId}`).value,
                customer: document.getElementById(`customer-input-${firestoreId}`).value,
                tujuan: document.getElementById(`tujuan-input-${firestoreId}`).value,
                waktu: document.getElementById(`waktu-input-${firestoreId}`).value
            };
            const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
            try {
                await updateDoc(truckDocRef, dataToUpdate);
                buttonElement.innerHTML = `✓ Berhasil`;
                setTimeout(() => { buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false; }, 2000);
            } catch (error) { alert("Gagal menyimpan perubahan."); buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false; }
        };

        window.finishDelivery = async (firestoreId) => {
            if (confirm("Apakah Anda Yakin? Ini akan dihitung sebagai 1 ritase.")) {
                const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
                const dataTerbaru = {
                    keterangan: document.getElementById(`status-select-${firestoreId}`).value,
                    nama_driver: document.getElementById(`driver-input-${firestoreId}`).value,
                    no_hp: document.getElementById(`hp-input-${firestoreId}`).value,
                    fo: document.getElementById(`fo-input-${firestoreId}`).value,
                    customer: document.getElementById(`customer-input-${firestoreId}`).value,
                    tujuan: document.getElementById(`tujuan-input-${firestoreId}`).value,
                    waktu: document.getElementById(`waktu-input-${firestoreId}`).value
                };
                try {
                    await updateDoc(truckDocRef, dataTerbaru);
                    const ritaseData = {
                        angkutanName: currentUserData.angkutanName,
                        truckId: firestoreId,
                        plat_nomor: trucksData.find(t => t.firestoreId === firestoreId)?.no_mobil || 'N/A',
                        nama_driver: dataTerbaru.nama_driver || '-',
                        customer: dataTerbaru.customer || '-',
                        tujuan: dataTerbaru.tujuan || '-',
                        fo: dataTerbaru.fo || '-',
                        timestamp_selesai: serverTimestamp()
                    };
                    await addDoc(collection(db, "completed_deliveries"), ritaseData);
                    const dataToReset = { keterangan: "TERSEDIA", fo: "", customer: "", tujuan: "", waktu: "" };
                    await updateDoc(truckDocRef, dataToReset);
                    alert('Delivery selesai dan 1 ritase telah dicatat.');
                } catch (error) {
                    console.error("Error pada proses finishDelivery: ", error);
                    alert("Gagal menyelesaikan delivery. Silakan coba lagi.");
                }
            }
        };

        function displayStatusCards(trucks) {
            const container = document.getElementById('readOnlyTruckList'); container.innerHTML = '';
            if (!trucks || trucks.length === 0) { container.innerHTML = `<p class="text-slate-500 col-span-full text-center">Tidak ada data.</p>`; return; }
            trucks.forEach((truck) => container.appendChild(createStatusCard(truck)));
        }

        function createStatusCard(truck) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-md';
            card.setAttribute('data-id', truck.firestoreId);
            const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
            const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
            const kubikasi = (p * l * t / 1000000).toFixed(2);
            const [tanggal, jam] = (truck.waktu || 'T').split('T');
            const waktuDisplay = tanggal && jam ? `${tanggal}, ${jam}` : '-';
            card.innerHTML = `<div class="flex justify-between items-start"><h3 class="text-lg font-bold text-slate-800">${truck.no_mobil}</h3><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${truck.keterangan || 'N/A'}</span></div><p class="text-sm text-slate-500 mb-4">${truck.jenis_mobil || ''}</p><div class="border-t border-slate-200 pt-4 mt-4 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Customer:</span><span class="text-slate-700 font-semibold">${truck.customer || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kota:</span><span class="text-slate-700 font-semibold">${truck.tujuan || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Waktu:</span><span class="text-slate-700 font-semibold">${waktuDisplay}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Driver:</span><span class="text-slate-700 font-semibold">${truck.nama_driver || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No HP:</span><span class="text-slate-700 font-semibold">${truck.no_hp || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No. FO:</span><span class="text-slate-700 font-semibold">${truck.fo || '-'}</span></div></div><div class="border-t border-slate-200 pt-2 mt-2 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Dimensi:</span><span class="text-slate-700 font-semibold">${p}×${l}×${t} cm</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kubikasi:</span><span class="text-slate-700 font-bold text-indigo-600">${kubikasi} m³</span></div></div>`;
            return card;
        }

        function displayDimensiTable(trucks) {
            const tableBody = document.getElementById('dimensiTableBody'); tableBody.innerHTML = '';
            if (!trucks || trucks.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`; return; }
            trucks.forEach(truck => tableBody.appendChild(createDimensionRow(truck)));
        }

        function createDimensionRow(truck) {
            const row = document.createElement('tr'); row.className = 'bg-white border-b hover:bg-slate-50';
            row.setAttribute('data-id', truck.firestoreId);
            const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
            const kubikasi = (p * l * t / 1000000).toFixed(2);
            row.innerHTML = `<td class="px-6 py-4 font-medium">${truck.no_mobil}</td><td class="px-6 py-4">${truck.jenis_mobil || '-'}</td><td data-field="panjang" class="px-6 py-4">${p}</td><td data-field="lebar" class="px-6 py-4">${l}</td><td data-field="tinggi" class="px-6 py-4">${t}</td><td data-field="kubikasi" class="px-6 py-4 font-semibold">${kubikasi}</td><td class="px-6 py-4 action-buttons"><button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" onclick="window.editDimensions('${truck.firestoreId}')"><i class="fas fa-pencil-alt"></i></button></td>`;
            return row;
        }

        window.editDimensions = (firestoreId) => {
            window.cancelEditDimensions();
            const row = document.querySelector(`#dimensiTableBody tr[data-id="${firestoreId}"]`); if (!row) return;
            const createInput = (value) => `<input type="number" class="w-full p-2 border border-slate-300 rounded-lg" value="${value}" oninput="window.updateKubikasi('${firestoreId}')">`;
            row.querySelector('td[data-field="panjang"]').innerHTML = createInput(row.querySelector('td[data-field="panjang"]').textContent);
            row.querySelector('td[data-field="lebar"]').innerHTML = createInput(row.querySelector('td[data-field="lebar"]').textContent);
            row.querySelector('td[data-field="tinggi"]').innerHTML = createInput(row.querySelector('td[data-field="tinggi"]').textContent);
            row.querySelector('.action-buttons').innerHTML = `<button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveDimensions('${firestoreId}')"><i class="fas fa-check"></i></button><button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg ml-2" onclick="window.cancelEditDimensions()"><i class="fas fa-times"></i></button>`;
        };

        window.updateKubikasi = (firestoreId) => {
            const row = document.querySelector(`#dimensiTableBody tr[data-id="${firestoreId}"]`); if (!row) return;
            const p = parseFloat(row.querySelector('td[data-field="panjang"] input').value) || 0, l = parseFloat(row.querySelector('td[data-field="lebar"] input').value) || 0, t = parseFloat(row.querySelector('td[data-field="tinggi"] input').value) || 0;
            row.querySelector('td[data-field="kubikasi"]').textContent = (p * l * t / 1000000).toFixed(2);
        };

        window.saveDimensions = async (firestoreId) => {
            const row = document.querySelector(`#dimensiTableBody tr[data-id="${firestoreId}"]`); if (!row) return;
            const dataToUpdate = { 
                panjang: parseFloat(row.querySelector('td[data-field="panjang"] input').value) || 0, 
                lebar: parseFloat(row.querySelector('td[data-field="lebar"] input').value) || 0, 
                tinggi: parseFloat(row.querySelector('td[data-field="tinggi"] input').value) || 0, 
            };
            const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
            try { 
                await updateDoc(truckDocRef, dataToUpdate);
                window.cancelEditDimensions(); 
            } catch(e) { 
                alert('Gagal menyimpan data.'); 
                console.error("Gagal menyimpan dimensi:", e);
            }
        };

        window.cancelEditDimensions = () => displayDimensiTable(trucksData);

        function renderSummaryReport(trucks) {
            const tableBody = document.getElementById('summaryTableBody'); tableBody.innerHTML = '';
            if (!trucks || trucks.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`; return; }
            trucks.forEach(truck => {
                const row = document.createElement('tr'); row.className = 'bg-white border-b hover:bg-slate-50';
                row.innerHTML = `<td class="px-6 py-4 font-medium">${truck.fo || '-'}</td><td class="px-6 py-4">${truck.keterangan || '-'}</td><td class="px-6 py-4">${truck.nama_driver || '-'}</td><td class="px-6 py-4">${truck.no_hp || '-'}</td><td class="px-6 py-4">${truck.no_mobil || '-'}</td><td class="px-6 py-4">${truck.jenis_mobil || '-'}</td>`;
                tableBody.appendChild(row);
            });
        }
        
        // --- FUNGSI UNTUK RITASE DENGAN FILTER POP-UP DI HEADER ---
        let currentFilterColumn = null;

        function closeFilterPopup() {
            const popup = document.getElementById('header-filter-popup');
            if (popup) popup.classList.add('hidden');
            currentFilterColumn = null;
        }

        window.openFilterPopup = (event, column) => {
            event.stopPropagation();
            const popup = document.getElementById('header-filter-popup');
            const filterOptions = document.getElementById('filter-options');
            const searchInput = document.getElementById('filter-search');

            if (currentFilterColumn === column && !popup.classList.contains('hidden')) {
                closeFilterPopup();
                return;
            }
            
            currentFilterColumn = column;
            const uniqueValues = [...new Set(allRitaseData.map(item => item[column]))].filter(Boolean).sort();
            
            filterOptions.innerHTML = '';
            uniqueValues.forEach(value => {
                const isChecked = activeFilters[column] && activeFilters[column].includes(String(value));
                const itemHtml = `<label class="filter-item flex items-center"><input type="checkbox" value="${value}" ${isChecked ? 'checked' : ''} class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span>${value}</span></label>`;
                filterOptions.innerHTML += itemHtml;
            });

            searchInput.value = '';
            searchInput.onkeyup = () => {
                const term = searchInput.value.toLowerCase();
                document.querySelectorAll('#filter-options .filter-item').forEach(item => {
                    const text = item.querySelector('span').textContent.toLowerCase();
                    item.style.display = text.includes(term) ? 'flex' : 'none';
                });
            };

            const headerRect = event.currentTarget.getBoundingClientRect();
            popup.style.left = `${headerRect.left}px`;
            popup.style.top = `${headerRect.bottom + window.scrollY}px`;
            popup.classList.remove('hidden');
        }

        function applyHeaderFilters() {
            if (!currentFilterColumn) return;
            const selectedValues = [];
            document.querySelectorAll('#filter-options input[type="checkbox"]:checked').forEach(checkbox => {
                selectedValues.push(checkbox.value);
            });
            
            if (selectedValues.length > 0) {
                activeFilters[currentFilterColumn] = selectedValues;
            } else {
                delete activeFilters[currentFilterColumn];
            }
            applyRitaseFiltersAndSort();
            closeFilterPopup();
        }

        function clearHeaderFilters() {
            if (!currentFilterColumn) return;
            delete activeFilters[currentFilterColumn];
            applyRitaseFiltersAndSort();
            closeFilterPopup();
        }

        function displayRitaseTable(dataToRender) {
            const tableBody = document.getElementById('ritaseTableBody');
            tableBody.innerHTML = '';
            if (!dataToRender || dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">Tidak ada data ritase yang cocok.</td></tr>`;
                return;
            }
            dataToRender.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                const formattedDate = data.timestamp_selesai?.toDate() 
                    ? data.timestamp_selesai.toDate().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta', dateStyle: 'long', timeStyle: 'short'}) + ' WIB' 
                    : '-';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium">${data.plat_nomor || '-'}</td>
                    <td class="px-6 py-4">${data.nama_driver || '-'}</td>
                    <td class="px-6 py-4">${data.customer || '-'}</td>
                    <td class="px-6 py-4">${data.tujuan || '-'}</td>
                    <td class="px-6 py-4">${formattedDate}</td>
                    <td class="px-6 py-4">${data.fo || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function applyRitaseFiltersAndSort() {
            let filtered = [...allRitaseData];

            for (const column in activeFilters) {
                if (activeFilters[column] && activeFilters[column].length > 0) {
                    filtered = filtered.filter(item => activeFilters[column].includes(String(item[column])));
                }
            }
            
            filtered.sort((a, b) => {
                const valA = a[ritaseSort.column];
                const valB = b[ritaseSort.column];
                if (ritaseSort.column === 'timestamp_selesai') {
                    const timeA = valA?.toMillis() || 0;
                    const timeB = valB?.toMillis() || 0;
                    return ritaseSort.direction === 'asc' ? timeA - timeB : timeB - timeA;
                }
                const comparison = String(valA || '').localeCompare(String(valB || ''), undefined, { numeric: true });
                return ritaseSort.direction === 'asc' ? comparison : -comparison;
            });

            displayRitaseTable(filtered);
        }
        
        window.sortRitaseTable = (column) => {
            if (ritaseSort.column === column) {
                ritaseSort.direction = ritaseSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                ritaseSort.column = column;
                ritaseSort.direction = 'asc';
            }
            applyRitaseFiltersAndSort();
        };
        
        window.handleHeaderClick = (event, column) => {
            if (event.shiftKey) {
                sortRitaseTable(column);
            } else {
                openFilterPopup(event, column);
            }
        };

        async function fetchAndRenderRitase() {
            const tableBody = document.getElementById('ritaseTableBody');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data ritase...</td></tr>`;
            const ritaseRef = collection(db, "completed_deliveries");
            const q = query(ritaseRef, where("angkutanName", "==", currentUserData.angkutanName));
            
            try {
                const querySnapshot = await getDocs(q);
                allRitaseData = querySnapshot.docs.map(doc => doc.data());
                ritaseSort = { column: 'timestamp_selesai', direction: 'desc' };
                activeFilters = {};
                applyRitaseFiltersAndSort(); 
            } catch (error) {
                console.error("Gagal memuat data ritase: ", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Terjadi kesalahan.</td></tr>`;
            }
        }

        // ===== START: FUNGSI-FUNGSI BARU UNTUK MODAL =====
        window.showTrucksByStatus = (status) => {
            const modal = document.getElementById('status-modal');
            const modalTitle = document.getElementById('modal-title');
            const searchInput = document.getElementById('modalSearchInput');
            
            currentModalTrucks = trucksData.filter(truck => truck.keterangan === status);
            modalTitle.textContent = `Daftar Truk: ${status}`;
            searchInput.value = '';
            modalSort = { column: 'no_mobil', direction: 'asc' }; // Reset sort
            
            applyModalFiltersAndSort(); // Terapkan filter & sort awal
            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('status-modal').classList.add('hidden');
        };

        function renderModalTable(trucksToRender) {
            const modalList = document.getElementById('modal-truck-list');
            modalList.innerHTML = '';
            if (!trucksToRender || trucksToRender.length === 0) {
                modalList.innerHTML = '<tr><td colspan="6" class="text-center p-6 text-slate-500">Tidak ada truk yang cocok.</td></tr>';
                return;
            }
            trucksToRender.forEach(truck => {
                const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
                const dimensi = `${p}×${l}×${t}`;
                const kubikasi = (p * l * t / 1000000).toFixed(2);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-slate-50';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${truck.no_mobil || '-'}</td>
                    <td class="px-4 py-3">${truck.nama_driver || '-'}</td>
                    <td class="px-4 py-3">${truck.no_hp || '-'}</td>
                    <td class="px-4 py-3">${truck.jenis_mobil || '-'}</td>
                    <td class="px-4 py-3">${dimensi}</td>
                    <td class="px-4 py-3 font-semibold">${kubikasi} m³</td>
                `;
                modalList.appendChild(row);
            });
        }

        window.applyModalFiltersAndSort = () => {
            const searchTerm = document.getElementById('modalSearchInput').value.toLowerCase();
            let filtered = [...currentModalTrucks];
            
            if (searchTerm) {
                filtered = filtered.filter(truck => 
                    Object.values(truck).some(val => String(val).toLowerCase().includes(searchTerm))
                );
            }

            filtered.sort((a, b) => {
                const valA = a[modalSort.column] || '';
                const valB = b[modalSort.column] || '';
                const comparison = String(valA).localeCompare(String(valB), undefined, { numeric: true });
                return modalSort.direction === 'asc' ? comparison : -comparison;
            });

            renderModalTable(filtered);
        }

        window.sortModalTable = (column) => {
            if (modalSort.column === column) {
                modalSort.direction = modalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                modalSort.column = column;
                modalSort.direction = 'asc';
            }
            applyModalFiltersAndSort();
        };
        // ===== END: FUNGSI-FUNGSI BARU UNTUK MODAL =====
        
        // ===== START: FUNGSI JAM REAL-TIME =====
        function updateRealTimeClock() {
            // Cari elemen untuk menampilkan waktu
            const clockElement = document.getElementById('export-timestamp');
            
            // Pastikan elemen ada di halaman yang aktif untuk menghindari error
            if (clockElement) {
                const now = new Date();
                const options = {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                };
                // Format waktu ke dalam Bahasa Indonesia
                clockElement.textContent = now.toLocaleString('id-ID', options);
            }
        }
        // ===== END: FUNGSI JAM REAL-TIME =====

        // ===== START: FUNGSI-FUNGSI EKSPOR =====
        function getFormattedTimestamp() {
            const now = new Date();
            const options = {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short'
            };
            // Menggunakan locale 'id-ID' untuk format Indonesia
            return now.toLocaleString('id-ID', options);
        }

        function getFilenameTimestamp() {
            const now = new Date();
            const YYYY = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const DD = String(now.getDate()).padStart(2, '0');
            const HH = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            return `${YYYY}-${MM}-${DD}_${HH}-${mm}`;
        }

        window.exportToExcel = () => {
            const timestamp = getFormattedTimestamp();
            document.getElementById('export-timestamp').textContent = `Data diekspor pada: ${timestamp}`;
            
            // Mengambil tabel dari DOM
            const table = document.getElementById('summaryTable');
            const workbook = XLSX.utils.table_to_book(table, {sheet: "Summary Report"});
            
            // Membuat nama file dengan timestamp
            const filename = `Summary_Report_${getFilenameTimestamp()}.xlsx`;
            XLSX.writeFile(workbook, filename);
        };

        window.exportToPdf = () => {
            const timestamp = getFormattedTimestamp();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            document.getElementById('export-timestamp').textContent = `Data diekspor pada: ${timestamp}`;

            // Menambahkan Judul dan Timestamp ke PDF
            doc.text("Summary Report Logistik", 14, 15);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Diekspor pada: ${timestamp}`, 14, 22);

            // Menggunakan autoTable untuk mengkonversi tabel HTML ke PDF
            doc.autoTable({
                html: '#summaryTable',
                startY: 28, // Posisi awal tabel setelah judul
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] } // Warna header (indigo)
            });
            
            // Membuat nama file dengan timestamp
            const filename = `Summary_Report_${getFilenameTimestamp()}.pdf`;
            doc.save(filename);
        };
        // ===== END: FUNGSI-FUNGSI EKSPOR =====

        const pageTitles = { home: 'Home', statusTruck: 'Status Truck (View Only)', updateStatus: 'Update Status Truck', updateDimensi: 'Update Dimensi Truck', ritaseTruck: 'Laporan Ritase Truck', summaryReport: 'Summary Report' };
        window.showContent = (contentId) => {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(contentId).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${contentId}`).classList.add('active');
            document.getElementById('page-title').textContent = pageTitles[contentId];
            
            if (contentId === 'ritaseTruck') {
                fetchAndRenderRitase();
            } else if (contentId === 'updateStatus') {
                const container = document.getElementById('truckListContainer');
                container.innerHTML = '';
                trucksData.forEach(truck => container.appendChild(createTruckCard(truck)));
            } else if (contentId === 'statusTruck') {
                displayStatusCards(trucksData);
            } else if (contentId === 'updateDimensi') {
                displayDimensiTable(trucksData);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateRealTimeClock, 1000);

            document.getElementById('loginButton').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value).catch(e => document.getElementById('loginError').textContent = 'Email atau password salah.'));
            document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
            
            document.getElementById('apply-filter-btn').addEventListener('click', applyHeaderFilters);
            document.getElementById('clear-filter-btn').addEventListener('click', clearHeaderFilters);
            document.addEventListener('click', (event) => {
                const popup = document.getElementById('header-filter-popup');
                if (!popup.classList.contains('hidden') && !popup.contains(event.target) && !event.target.closest('th[data-filter]')) {
                    closeFilterPopup();
                }
            });
        });
    </script>
</body>
</html>
